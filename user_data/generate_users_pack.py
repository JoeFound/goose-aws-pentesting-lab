# import pyyaml module
import yaml
import os
import zipfile
import shutil

from yaml.loader import SafeLoader    

USERS_FILE = 'users.yml'

if os.path.exists(USERS_FILE):
    # Open the file and load the file
    with open(USERS_FILE) as f:
        data = yaml.load(f, Loader=SafeLoader)
else:
    print(f"Error! loading file {USERS_FILE}")
    exit(-1)
        
     
        
# VPN Config Files
client_vpn_user_file="""
[Interface]
PrivateKey = ###PRIVATEKEY###
ListenPort = 21841
Address = ###ADDRESS###/32

[Peer]
PublicKey = ###SERVER_PUBKEY###
AllowedIPs = 10.0.10.1/32,10.0.0.0/24,10.0.1.0/24
Endpoint = ###DNSNAME###:51820

# This is for if you're behind a NAT and
# want the connection to be kept alive.
PersistentKeepalive = 25
"""

client_vpn_user_file = client_vpn_user_file.replace("###DNSNAME###", data["server"]["dnsname"])
client_vpn_user_file = client_vpn_user_file.replace("###SERVER_PUBKEY###", data["server"]["wireguard_keys"]["public"])



# Additionally create a pack file with user data
index=0
user_ip=10
for user in data["users"]:
    _user_name = user["name"]
    _client_vpn_user_file = client_vpn_user_file
    _client_vpn_user_file = _client_vpn_user_file.replace("###PRIVATEKEY###", user["wireguard_keys"]["private"])
    _client_vpn_user_file = _client_vpn_user_file.replace("###ADDRESS###", f"10.0.10.{str(user_ip)}")
    
    user_directory = f"outputs/{_user_name}"
    if not os.path.exists(user_directory):
        os.mkdir(user_directory)
    
    password_output_file= f"outputs/{_user_name}/{_user_name}_password.txt"
    with open(password_output_file, 'w') as file:
        file.writelines(user["password"])
        
    sshkey_output_file= f"outputs/{_user_name}/{_user_name}.key"
    with open(sshkey_output_file, 'w') as file:
        file.writelines(user["ssh_keys"]["private"])
    os.chmod(sshkey_output_file, 0o600)
        
    sshkeypub_output_file= f"outputs/{_user_name}/{_user_name}.pub"
    with open(sshkeypub_output_file, 'w') as file:
        file.writelines(user["ssh_keys"]["public"])
        
    wg_output_file= f"outputs/{_user_name}/client_vpn_{_user_name}.wg"
    with open(wg_output_file, 'w') as file:
        file.writelines(_client_vpn_user_file)
        
        
    
    zip_file = f"outputs/{_user_name}_pack"
    zip_contents_dir = f"outputs/{_user_name}/"
    shutil.make_archive(zip_file,'zip', root_dir=None, base_dir=zip_contents_dir)        
    
    index=index+1
    user_ip=user_ip+1

